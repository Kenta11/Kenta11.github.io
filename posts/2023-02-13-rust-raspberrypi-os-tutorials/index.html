<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="index, follow"><meta name=author content><meta name=description content><link rel=author type=text/plain href=/humans.txt><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon href=/favicon.ico type=image/x-icon><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileImage content="/mstile-144x144.png"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><link rel=mask-icon href=/safari-pinned-tab.svg color=#494f5c><meta itemprop=name content="Operating System development tutorials in Rust on the Raspberry Pi をする #5"><meta itemprop=description content="はじめに 前回の続きから．
05_drivers_gpio_uart 概要 UART と GPIO のコントローラ用ドライバを追加する これまでに作成した QEMU コンソールを捨てて， ドライバマネージャ を導入する ドライバマネージャ ドライバサブシステム をカーネルに追加"><meta itemprop=datePublished content="2023-02-13T23:00:00+09:00"><meta itemprop=dateModified content="2023-02-13T23:00:00+09:00"><meta itemprop=wordCount content="577"><meta itemprop=keywords content="Rust,Raspberry Pi,Operating System"><meta property="og:url" content="https://Kenta11.github.io/posts/2023-02-13-rust-raspberrypi-os-tutorials/"><meta property="og:site_name" content="Kenta Arai Webpage"><meta property="og:title" content="Operating System development tutorials in Rust on the Raspberry Pi をする #5"><meta property="og:description" content="はじめに 前回の続きから．
05_drivers_gpio_uart 概要 UART と GPIO のコントローラ用ドライバを追加する これまでに作成した QEMU コンソールを捨てて， ドライバマネージャ を導入する ドライバマネージャ ドライバサブシステム をカーネルに追加"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-13T23:00:00+09:00"><meta property="article:modified_time" content="2023-02-13T23:00:00+09:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Raspberry Pi"><meta property="article:tag" content="Operating System"><meta name=twitter:card content="summary"><meta name=twitter:title content="Operating System development tutorials in Rust on the Raspberry Pi をする #5"><meta name=twitter:description content="はじめに 前回の続きから．
05_drivers_gpio_uart 概要 UART と GPIO のコントローラ用ドライバを追加する これまでに作成した QEMU コンソールを捨てて， ドライバマネージャ を導入する ドライバマネージャ ドライバサブシステム をカーネルに追加"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Operating System development tutorials in Rust on the Raspberry Pi をする #5","name":"Operating System development tutorials in Rust on the Raspberry Pi をする #5","description":"はじめに 前回の続きから．\n05_drivers_gpio_uart 概要 UART と GPIO のコントローラ用ドライバを追加する これまでに作成した QEMU コンソールを捨てて， ドライバマネージャ を導入する ドライバマネージャ ドライバサブシステム をカーネルに追加\n","keywords":["Rust","Raspberry Pi","Operating System"],"articleBody":"はじめに 前回の続きから．\n05_drivers_gpio_uart 概要 UART と GPIO のコントローラ用ドライバを追加する これまでに作成した QEMU コンソールを捨てて， ドライバマネージャ を導入する ドライバマネージャ ドライバサブシステム をカーネルに追加\n参照：src/driver.rs interface::DeviceDriver トレイトは各デバイスドライバが実装する必要がある\ncrate::driver::driver_manager().init_drivers(...) はドライバマネージャに全ての登録済みドライバをループさせ，初期化をキックし，オプションの 初期化後コールバック も実行する\nBSP ドライバ実装 src/bsp/raspberrypi/driver.rs の init() が UART と GPIO の登録の面倒をみる\nドライバは src/bsp/device_driver に保存されており，BSP が使用する\nまず PL011Uart ドライバを追加する\nconsole::interface::* トレイトを実装 メインシステムのコンソールとして使用 次に GPIO ドライバを追加する\nこのドキュメントでは Raspberry Pi 3 向けに Makefile が書かれている Raspberry Pi 4 向けにビルドする場合は ターゲットに BSP=rpi4 を指定 Raspberry Pi 3 しか持っていないので読み飛ばす BSP は src/bsp/raspberrypi/memory.rs でメモリマップをもつ\nSD カードからブートする boot という名前の FAT32 のパーティションを作成 所定の内容の config.txt を作成 Raspberry Pi firmware repo から bootcode.bin, fixup.dat, start.elf をコピー make を実行 kernel8.img をSDカードにコピーし，Raspberry Pi に挿入 シリアル通信端末で UART と接続 USB シリアルとホストPCを接続 Raspberry Pi を電源に接続し，出力を観察する 実行結果 $ make Compiling kernel ELF - rpi3 Compiling mingo v0.5.0 (/home/kenta/Git/Kenta11/rust-raspberrypi-OS-tutorials/05_drivers_gpio_uart) Compiling tock-registers v0.8.1 Compiling aarch64-cpu v9.0.0 Finished release [optimized] target(s) in 1.83s Generating stripped binary Name kernel8.img Size 10 KiB $ sudo make qemu [sudo] kenta のパスワード: Launching QEMU [0] mingo version 0.5.0 [1] Booting on: Raspberry Pi 3 [2] Drivers loaded: 1. BCM PL011 UART 2. BCM GPIO [3] Chars written: 117 [4] Echoing input now ","wordCount":"577","inLanguage":"en","datePublished":"2023-02-13T23:00:00+09:00","dateModified":"2023-02-13T23:00:00+09:00","author":{"@type":"Person","name":null},"mainEntityOfPage":{"@type":"WebPage","@id":"https://Kenta11.github.io/posts/2023-02-13-rust-raspberrypi-os-tutorials/"},"publisher":{"@type":"Organization","name":"Kenta Arai Webpage","description":"","logo":{"@type":"ImageObject","url":"https://Kenta11.github.io/favicon.ico"}}}</script><title>Operating System development tutorials in Rust on the Raspberry Pi をする #5</title>
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as=style href=https://Kenta11.github.io/css/style.min.d3facc2d5fe42af72ee5a80584900a45ffee6035df0ef582bd8696c2fe0c9da5.css integrity="sha256-0/rMLV/kKvcu5agFhJAKRf/uYDXfDvWCvYaWwv4MnaU=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://Kenta11.github.io/>Kenta Arai Webpage</a></div><nav class="site-nav hide-in-mobile"><a href=https://Kenta11.github.io/posts/>Posts</a><a href=https://Kenta11.github.io/about/>About</a><a href=https://Kenta11.github.io/projects/>Projects</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/isKenta14 target=_blank rel="noopener me" title=Twitter><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/Kenta11 target=_blank rel="noopener me" title=Github><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://gitlab.com/Kenta111 target=_blank rel="noopener me" title=Gitlab><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.65 14.39 12 22.13 1.35 14.39a.84.84.0 01-.3-.94l1.22-3.78 2.44-7.51A.42.42.0 014.82 2a.43.43.0 01.58.0.42.42.0 01.11.18l2.44 7.49h8.1l2.44-7.51A.42.42.0 0118.6 2a.43.43.0 01.58.0.42.42.0 01.11.18l2.44 7.51L23 13.45a.84.84.0 01-.35.94z"/></svg></a><a href=https://qiita.com/Kenta11 target=_blank rel="noopener me" title=Qiita><svg class="feather feather-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a><a href=https://speakerdeck.com/kenta11 target=_blank rel="noopener me" title=Speakerdeck><svg class="feather feather-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></a></span><button id=menu-btn class=hdr-btn title><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://Kenta11.github.io/posts/>Posts</a></li><li><a href=https://Kenta11.github.io/about/>About</a></li><li><a href=https://Kenta11.github.io/projects/>Projects</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-date><span>Feb 13, 2023</span></div><h1>Operating System development tutorials in Rust on the Raspberry Pi をする #5</h1></header><div class=post-description><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://Kenta11.github.io/tags/rust>Rust</a></span><span class=tag><a href=https://Kenta11.github.io/tags/raspberry-pi>Raspberry Pi</a></span><span class=tag><a href=https://Kenta11.github.io/tags/operating-system>Operating System</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>577&nbspWords</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2023-02-13 14:00 +0000</p></div><hr class=post-end><div class=content><h1 id=はじめに>はじめに<a href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><p><a href=../2023-02-02-rust-raspberrypi-os-tutorials>前回</a>の続きから．</p><h1 id=05_><a href=https://github.com/rust-embedded/rust-raspberrypi-OS-tutorials/tree/master/05_drivers_gpio_uart>05_drivers_gpio_uart</a><a href=#05_ class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h1><h2 id=概要>概要<a href=#%e6%a6%82%e8%a6%81 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li>UART と GPIO のコントローラ用ドライバを追加する<ul><li>これまでに作成した QEMU コンソールを捨てて， <code>ドライバマネージャ</code> を導入する</li></ul></li></ul><h2 id=ドライバマネージャ>ドライバマネージャ<a href=#%e3%83%89%e3%83%a9%e3%82%a4%e3%83%90%e3%83%9e%e3%83%8d%e3%83%bc%e3%82%b8%e3%83%a3 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><p><code>ドライバサブシステム</code> をカーネルに追加</p><ul><li>参照：<code>src/driver.rs</code></li></ul></li><li><p><code>interface::DeviceDriver</code> トレイトは各デバイスドライバが実装する必要がある</p></li><li><p><code>crate::driver::driver_manager().init_drivers(...)</code> はドライバマネージャに全ての登録済みドライバをループさせ，初期化をキックし，オプションの <code>初期化後コールバック</code> も実行する</p></li></ul><h2 id=bsp-ドライバ実装>BSP ドライバ実装<a href=#bsp-%e3%83%89%e3%83%a9%e3%82%a4%e3%83%90%e5%ae%9f%e8%a3%85 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ul><li><p><code>src/bsp/raspberrypi/driver.rs</code> の <code>init()</code> が <code>UART</code> と <code>GPIO</code> の登録の面倒をみる</p></li><li><p>ドライバは <code>src/bsp/device_driver</code> に保存されており，<code>BSP</code> が使用する</p></li><li><p>まず <code>PL011Uart</code> ドライバを追加する</p><ul><li><code>console::interface::*</code> トレイトを実装</li><li>メインシステムのコンソールとして使用</li></ul></li><li><p>次に <code>GPIO</code> ドライバを追加する</p><ul><li>このドキュメントでは Raspberry Pi 3 向けに <code>Makefile</code> が書かれている</li><li>Raspberry Pi 4 向けにビルドする場合は ターゲットに <code>BSP=rpi4</code> を指定<ul><li>Raspberry Pi 3 しか持っていないので読み飛ばす</li></ul></li></ul></li><li><p><code>BSP</code> は <code>src/bsp/raspberrypi/memory.rs</code> でメモリマップをもつ</p></li></ul><h2 id=sd-カードからブートする>SD カードからブートする<a href=#sd-%e3%82%ab%e3%83%bc%e3%83%89%e3%81%8b%e3%82%89%e3%83%96%e3%83%bc%e3%83%88%e3%81%99%e3%82%8b class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><ol><li><code>boot</code> という名前の <code>FAT32</code> のパーティションを作成</li><li>所定の内容の <code>config.txt</code> を作成</li><li><a href=https://github.com/raspberrypi/firmware/tree/master/ot>Raspberry Pi firmware repo</a> から <a href=https://github.com/raspberrypi/firmware/raw/master/boot/otcode.bin>bootcode.bin</a>, <a href=https://github.com/raspberrypi/firmware/raw/master/boot/xup.dat>fixup.dat</a>, <a href=https://github.com/raspberrypi/firmware/raw/master/boot/start.f>start.elf</a> をコピー</li><li><code>make</code> を実行</li><li><code>kernel8.img</code> をSDカードにコピーし，Raspberry Pi に挿入</li><li>シリアル通信端末で <code>UART</code> と接続</li><li>USB シリアルとホストPCを接続</li><li>Raspberry Pi を電源に接続し，出力を観察する</li></ol><h2 id=実行結果>実行結果<a href=#%e5%ae%9f%e8%a1%8c%e7%b5%90%e6%9e%9c class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ make
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Compiling kernel ELF - rpi3
</span></span><span class=line><span class=cl>   Compiling mingo v0.5.0 <span class=o>(</span>/home/kenta/Git/Kenta11/rust-raspberrypi-OS-tutorials/05_drivers_gpio_uart<span class=o>)</span>
</span></span><span class=line><span class=cl>   Compiling tock-registers v0.8.1
</span></span><span class=line><span class=cl>   Compiling aarch64-cpu v9.0.0
</span></span><span class=line><span class=cl>    Finished release <span class=o>[</span>optimized<span class=o>]</span> target<span class=o>(</span>s<span class=o>)</span> in 1.83s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Generating stripped binary
</span></span><span class=line><span class=cl>        Name kernel8.img
</span></span><span class=line><span class=cl>        Size <span class=m>10</span> KiB
</span></span><span class=line><span class=cl>$ sudo make qemu
</span></span><span class=line><span class=cl><span class=o>[</span>sudo<span class=o>]</span> kenta のパスワード:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Launching QEMU
</span></span><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> mingo version 0.5.0
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> Booting on: Raspberry Pi <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2<span class=o>]</span> Drivers loaded:
</span></span><span class=line><span class=cl>      1. BCM PL011 UART
</span></span><span class=line><span class=cl>      2. BCM GPIO
</span></span><span class=line><span class=cl><span class=o>[</span>3<span class=o>]</span> Chars written: <span class=m>117</span>
</span></span><span class=line><span class=cl><span class=o>[</span>4<span class=o>]</span> Echoing input now
</span></span></code></pre></div></div></article><div class="post-nav thin"><a class=next-post href=https://Kenta11.github.io/posts/2023-03-18-micro-alpha/><span class=post-nav-label><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>情報工学実験II（再々履修）</span>
</a><a class=prev-post href=https://Kenta11.github.io/posts/2023-02-02-rust-raspberrypi-os-tutorials/><span class=post-nav-label>Older&nbsp;<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Operating System development tutorials in Rust on the Raspberry Pi をする #4</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2025 <a href=https://Kenta11.github.io/>Kenta Arai Webpage</a>
&#183; &#183; Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>
&#183; Theme <a href=https://github.com/1bl4z3r/hermit-V2 target=_blank rel=noopener>Hermit-V2</a></p></footer><script async src=https://Kenta11.github.io/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin=anonymous></script></body></html>